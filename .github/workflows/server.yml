name: Nginx Proxy

on:
  push:
    branches:
    - proxy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: LuisEnMarroquin/setup-ssh-action@v2.0.0
      with:
        ORIGIN: whoami.marroquin.dev
        SSHKEY: ${{ secrets.SSH_SERVER }}
        NAME: production
        PORT: ${{ secrets.SSH_PORT }}
        USER: ${{ secrets.SSH_USER }}
    - name: Delete folder and recreate
      run: ssh production 'rm -rf /opt/.github/proxy && mkdir -p /opt/.github/proxy'
    - name: Send files over ssh with scp
      run: scp compose-nginx.yml production:/opt/.github/proxy
    - name: Pull all images from Docker Hub
      run: ssh production 'cd /opt/.github/proxy && docker-compose -f compose-nginx.yml pull'
    - name: Deploy project to remote server
      run: ssh production 'cd /opt/.github/proxy && docker-compose -f compose-nginx.yml --project-name proxy up -d --remove-orphans'
    - name: Delete files from remote server
      run: ssh production rm -rf /opt/.github/proxy
