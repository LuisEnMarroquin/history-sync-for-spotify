name: Self Hosted

on:
  push:
    branches:
    - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: yarn install --production --ignore-optional --pure-lockfile --non-interactive
    - run: docker login -u luisenmarroquin -p ${{ secrets.DOCKER_PASSWORD }}
    - run: docker build --tag luisenmarroquin/spotify-sync:latest .
    - run: docker push luisenmarroquin/spotify-sync:latest
    - uses: LuisEnMarroquin/setup-ssh-action@v1.2
      with:
        ORIGIN: spotify.marroquin.dev
        SSHKEY: ${{ secrets.SSH_SERVER }}
        HOST: production
        USER: ${{ secrets.SSH_USER }}
    - run: ssh production ls --help
    - run: ssh production 'mkdir /opt/.github || true'
    - run: ssh production 'rm -rf /opt/.github/spotify || true'
    - run: ssh production 'mkdir /opt/.github/spotify'
    - run: scp compose.yml production:/opt/.github/spotify
    - run: echo $?
